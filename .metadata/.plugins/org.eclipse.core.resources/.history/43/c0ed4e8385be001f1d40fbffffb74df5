package org.floodping;

import java.io.ByteArrayInputStream;
import java.io.DataInputStream;
import java.net.DatagramPacket;
import java.net.DatagramSocket;
import java.util.Formatter;

public class Main {

	public static void main(String[] args) {
		try {
			DatagramSocket serverSocket;
			serverSocket = new DatagramSocket(12345);
			byte[] receiveData = new byte[1024];
			while (true) {
				DatagramPacket receivePacket = new DatagramPacket(receiveData, receiveData.length);
				serverSocket.receive(receivePacket);

				DataInputStream dis = new DataInputStream(new ByteArrayInputStream(receiveData));
				dis.readByte();
				dis.readByte();
				dis.readByte();
				dis.readByte();
				byte type = dis.readByte();
				
				switch(type)
				{
				case 'g':
					short x1 = (short)(( dis.readByte() & 0xff ) << 8 | (dis.readByte() & 0xff ));
					short y1 = (short)(( dis.readByte() & 0xff ) << 8 | (dis.readByte() & 0xff ));
					short z1 = (short)(( dis.readByte() & 0xff ) << 8 | (dis.readByte() & 0xff ));
					dis.readByte();
					short x2 = (short)(( dis.readByte() & 0xff ) << 8 | (dis.readByte() & 0xff ));
					short y2 = (short)(( dis.readByte() & 0xff ) << 8 | (dis.readByte() & 0xff ));
					short z3 = (short)(( dis.readByte() & 0xff ) << 8 | (dis.readByte() & 0xff ));
					if(x1!=x2 || y1!=y2 || z1!=z2)
					{
						System.out.println("error: " + x1 + "!=" + x2 + " || " + y1 + "!=" + y2 + " || " + z1 + "!=" + z2 + "");
						break;
					}
					System.out.println("ok: " + x1 + "," + y1 + "," + z1);
					double x = x1 / 2.3;
					double y = y1 / 2.3;
					double z = z1 / 2.3;
					System.out.println("g: " + x + "," + y + "," +z);
					break;
				case 'T':
					int temp = dis.readShort();
					double t = (temp >> 4) + ( (temp << 12) / 655300);
					Formatter f = new Formatter();
					String id = f.format("%02x:%02x:%02x:%02x:%02x:%02x", dis.readByte(), dis.readByte(), dis.readByte(), dis.readByte(), dis.readByte(), dis.readByte()).toString();
					System.out.println("T: " + t + "," + id);
					break;
				default:
					String sentence = new String(receivePacket.getData());
					System.out.println("RECEIVED: " + sentence);
				}
				
			}
		} catch (Exception e) {
			e.printStackTrace();
		}

	}

}
